@{
    Layout = null;
}
<div id="attendanceSection" class="dashboard-card bg-white p-4">
    <h5 class="mb-4 text-primary"><i class="fas fa-fingerprint me-2"></i> Chấm công</h5>

    <!-- Chọn ngày làm việc -->
    <div class="mb-3">
        <label class="form-label">Chọn ngày làm việc</label>
        <input type="text" class="form-control date-range" id="attendanceDateRange" placeholder="Chọn ngày làm việc">
    </div>

    <!-- Hiển thị các ngày làm việc đã chọn -->
    <div class="mt-3">
        <label class="form-label">Các ngày làm việc đã chọn</label>
        <div id="selectedDates"></div>
    </div>

    <!-- Giờ làm việc -->
    <div class="row mt-3">
        <div class="col-md-6">
            <label class="form-label">Giờ check-in</label>
            <input type="time" class="form-control" id="checkInTime">
        </div>
        <div class="col-md-6">
            <label class="form-label">Giờ check-out</label>
            <input type="time" class="form-control" id="checkOutTime">
        </div>
    </div>
    <!-- Hiển thị số giờ làm -->
    <div class="mt-3">
        <label class="form-label">Tổng số giờ làm trong tuần:</label>
        <input type="text" class="form-control w-50" id="weeklyHours" readonly>
    </div>
    <!-- Ghi chú -->
    <div class="mt-3">
        <label class="form-label">Ghi chú</label>
        <textarea class="form-control" id="attendanceNote" placeholder="Nhập ghi chú (nếu có)"></textarea>
    </div>

    <!-- Nút gửi dữ liệu -->
    <button class="btn btn-primary mt-3" id="submitAttendance">Chấm công</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let selectedWorkDays = new Set();

// Cấu hình Flatpickr
flatpickr("#attendanceDateRange", {
    mode: "multiple",
    dateFormat: "Y-m-d",
    onClose: function(selectedDates) {
        selectedWorkDays = new Set(selectedDates.map(date => date.toISOString().split('T')[0]));
        document.getElementById("selectedDates").innerHTML = [...selectedWorkDays].join("<br>");
    }
});

// Xử lý gửi dữ liệu chấm công
document.getElementById("submitAttendance").addEventListener("click", function() {
    const checkIn = document.getElementById("checkInTime").value;
    const checkOut = document.getElementById("checkOutTime").value;
    const note = document.getElementById("attendanceNote").value.trim();

    if (selectedWorkDays.size === 0) {
        Swal.fire("Lỗi!", "Vui lòng chọn ít nhất một ngày làm việc.", "error");
        return;
    }

let attendanceData = [...selectedWorkDays].map(day => ({
    MaNV: 1,
    NgayLamViec: new Date(day).toISOString().split("T")[0], // yyyy-MM-dd 
    GioVao: checkIn ? checkIn : null, // Không thêm ":00" 
    GioRa: checkOut ? checkOut : null, // Không thêm ":00" 
    TongGio: isNaN(parseFloat(calculateDailyHours(checkIn, checkOut))) ? 0 : parseFloat(calculateDailyHours(checkIn, checkOut)), // Đảm bảo không gửi NaN ✅
    TrangThai: "0",
    GhiChu: note || null
}));




    // Ghi log dữ liệu trước khi gửi
    console.log("Dữ liệu gửi đi:", JSON.stringify(attendanceData, null, 2));

    fetch('/api/Attendance/SubmitAttendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(attendanceData)

    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            Swal.fire("Thành công!", "Chấm công đã được ghi nhận.", "success");
        } else {
            Swal.fire("Lỗi!", "Có lỗi xảy ra khi chấm công.", "error");
        }
    })
    .catch(error => {
        Swal.fire("Lỗi!", "Không thể kết nối đến server.", "error");
    });
});



// Tính số giờ làm
function calculateDailyHours(checkIn, checkOut) {
    if (checkIn && checkOut) {
        const checkInTime = new Date(`2000-01-01T${checkIn}:00`);
        const checkOutTime = new Date(`2000-01-01T${checkOut}:00`);

        if (checkOutTime > checkInTime) {
            return parseFloat(((checkOutTime - checkInTime) / (1000 * 60 * 60)).toFixed(2));
        }
    }
    return 0.00; // Đảm bảo không trả về null
}



</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
