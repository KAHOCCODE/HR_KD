@{
    Layout = "~/Views/Shared/_ThemeLayout.cshtml";
    var maNv = User.Claims.FirstOrDefault(c => c.Type == "MaNV")?.Value;
    if (string.IsNullOrEmpty(maNv))
    {
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script>
                    Swal.fire('Lỗi!', 'Không tìm thấy mã nhân viên. Vui lòng đăng nhập lại.', 'error');
                </script>
        return;
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="~/css/attend.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">

<div class="dashboard-card bg-white p-4">
    <h5 class="mb-4 text-primary"><i class="fas fa-calendar-alt me-2"></i> Chấm công nâng cao</h5>
    <!-- Remaining Hours Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="form-group">
                <label for="_remainingHours" class="form-label fw-bold">Số giờ cần bù: </label>
                <span id="_remainingHours" class="fw-bold text-primary">Đang tải...</span>
                <div id="remainingHoursMessage" class="text-danger mt-2" style="display: none;">
                    Cần làm đủ giờ trước khi tăng ca
                </div>
            </div>
        </div>
    </div>
    <!-- Calendar Section -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="form-group">
                <label for="workDateRange" class="form-label">Chọn ngày làm việc</label>
                <input type="text" class="form-control date-range" id="workDateRange" placeholder="Chọn ngày làm việc">
            </div>
        </div>
    </div>

    <!-- Attendance and Overtime Controls -->
    <div class="row mb-4">
        <!-- Attendance Controls (Left) -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Chấm công</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary w-100" id="set8hBtn">
                                <i class="fas fa-clock me-2"></i>8h làm việc
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tổng giờ</label>
                                <input type="text" class="form-control" id="totalHours" readonly>
                            </div>
                        </div>
                        <div class="col-md-6 mt-2">
                            <div class="form-group">
                                <label>Giờ vào</label>
                                <input type="time" class="form-control" id="checkInTime">
                            </div>
                        </div>
                        <div class="col-md-6 mt-2">
                            <div class="form-group">
                                <label>Giờ ra</label>
                                <input type="time" class="form-control" id="checkOutTime">
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>Ghi chú</label>
                        <textarea class="form-control" id="attendanceNote" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overtime Controls (Right) -->
        <div class="col-md-6">
            <div class="card overtime-card">
                <div class="card-body">
                    <h6 class="card-title">Tăng ca</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Giờ vào tăng ca</label>
                                <input type="time" class="form-control" id="otStartTime">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Giờ ra tăng ca</label>
                                <input type="time" class="form-control" id="otEndTime">
                            </div>
                        </div>
                        <div class="col-md-12 mt-2">
                            <div class="form-group">
                                <label>Tỉ lệ tăng ca</label>
                                <select class="form-control" id="overtimeRate">
                                    <option value="">Chọn tỉ lệ tăng ca</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="btn-group w-100 mt-2">
                        <button class="btn btn-outline-primary" id="ot1h">+1 giờ</button>
                        <button class="btn btn-outline-primary" id="ot2h">+2 giờ</button>
                        <button class="btn btn-outline-primary" id="ot3h">+3 giờ</button>
                        <button class="btn btn-outline-primary" id="ot4h">+4 giờ</button>
                        <button class="btn btn-outline-primary" id="ot8h">8h-18h</button>
                        <button class="btn btn-outline-danger" id="cancelOT">Hủy</button>
                    </div>
                    <div class="mt-2">
                        <label>Ghi chú tăng ca</label>
                        <textarea class="form-control" id="otNote" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Schedule Table -->
    <div class="row mb-3">
        <div class="col-md-12">
            <button class="btn btn-success" id="applyToSelected">
                <i class="fas fa-check me-2"></i>Áp dụng cho ngày đã chọn
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered" id="workScheduleTable">
            <thead class="thead-light">
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th style="width: 100px;">Thứ</th>
                    <th>Ngày làm việc</th>
                    <th>Số giờ làm</th>
                    <th>Số giờ tăng ca</th>
                    <th>Ghi chú</th>
                </tr>
            </thead>
            <tbody id="workScheduleBody"></tbody>
        </table>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" id="submitAll">Lưu tất cả</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const maNv = '@maNv';
    let selectedWorkDays = [];
    let workScheduleData = {};
    let overtimeRates = [];
    let holidayData = {}; // Store holiday data

    document.addEventListener('DOMContentLoaded', async () => {
        if (!maNv) {
            Swal.fire('Lỗi!', 'Mã nhân viên không hợp lệ.', 'error');
            return;
        }
        try {
            // Load remaining hours
            const response = await fetch(`/api/LamBu/GetRemainingHours/${maNv}`);
            const result = await response.json();

            if (result.success) {
                document.getElementById('_remainingHours').textContent = `${result.remainingHours.toFixed(2)}h`;
                toggleOvertimeSection(result.remainingHours);
            } else {
                document.getElementById('_remainingHours').textContent = `0.00h`;
                toggleOvertimeSection(0);
            }

            // Load holiday data
            const holidayResponse = await fetch('/api/Attendance/GetHolidays');
            const holidayResult = await holidayResponse.json();
            if (holidayResult.success) {
                holidayData = holidayResult.holidays.reduce((acc, holiday) => {
                    acc[holiday.ngayLe] = holiday;
                    return acc;
                }, {});
            }
        } catch (error) {
            document.getElementById('_remainingHours').textContent = `0.00h`;
            toggleOvertimeSection(0);
        }
    });

    function toggleOvertimeSection(remainingHours) {
        const overtimeCard = document.querySelector('.overtime-card');
        const remainingHoursMessage = document.getElementById('remainingHoursMessage');

        if (remainingHours > 0) {
            overtimeCard.style.display = 'none';
            remainingHoursMessage.style.display = 'block'; // Hiển thị thông báo
        } else {
            overtimeCard.style.display = 'block';
            remainingHoursMessage.style.display = 'none'; // Ẩn thông báo
        }
    }

    async function loadOvertimeRates() {
        try {
            const response = await fetch('/api/Attendance/GetOvertimeRates');
            const result = await response.json();
            if (result.success) {
                overtimeRates = result.rates;
                const select = document.getElementById('overtimeRate');
                select.innerHTML = '<option value="">Chọn tỉ lệ tăng ca</option>';
                overtimeRates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate.id;
                    option.textContent = `${rate.tenTiLeTangCa} (Tỉ lệ: ${rate.tiLe})`;
                    select.appendChild(option);
                });
            } else {
                Swal.fire('Lỗi!', 'Không thể tải tỉ lệ tăng ca', 'error');
            }
        } catch (error) {
            Swal.fire('Lỗi!', 'Có lỗi xảy ra khi tải tỉ lệ tăng ca', 'error');
        }
    }

    document.getElementById('overtimeRate').addEventListener('change', function() {
        const selectedRateId = this.value;
        const selectedRate = overtimeRates.find(rate => rate.id == selectedRateId);
        const otNote = document.getElementById('otNote');
        if (selectedRate) {
            otNote.value = selectedRate.tenTiLeTangCa + (otNote.value ? ' - ' + otNote.value : '');
        } else {
            otNote.value = '';
        }
    });

    flatpickr("#workDateRange", {
        mode: "range",
        dateFormat: "d/m/Y",
        weekNumbers: true,
        locale: {
            firstDayOfWeek: 1 // Monday
        },
        minDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
        maxDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0),
        onClose: handleDateRangeClose
    });

    function handleDateRangeClose(selectedDates) {
        selectedWorkDays = [];
        if (selectedDates.length === 2) {
            let currentDate = new Date(selectedDates[0]);
            const endDate = new Date(selectedDates[1]);

            while (currentDate <= endDate) {
                const dateStr = formatDateToYMD(currentDate);
                selectedWorkDays.push(dateStr);
                if (!workScheduleData[dateStr]) {
                    workScheduleData[dateStr] = {
                        selected: false,
                        checkIn: '',
                        checkOut: '',
                        totalHours: 0,
                        overtimeHours: 0,
                        overtimeStart: '',
                        overtimeEnd: '',
                        overtimeNote: '',
                        attendanceNote: '',
                        overtimeRateId: null,
                        overtimeRateTiLe: 1
                    };
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
        } else if (selectedDates.length === 1) {
            const selectedDate = selectedDates[0];
            const dateStr = formatDateToYMD(selectedDate);
            selectedWorkDays.push(dateStr);
            if (!workScheduleData[dateStr]) {
                workScheduleData[dateStr] = {
                    selected: false,
                    checkIn: '',
                    checkOut: '',
                    totalHours: 0,
                    overtimeHours: 0,
                    overtimeStart: '',
                    overtimeEnd: '',
                    overtimeNote: '',
                    attendanceNote: '',
                    overtimeRateId: null,
                    overtimeRateTiLe: 1
                };
            }
        }
        updateWorkScheduleTable();
    }

    function formatDateToYMD(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function getDayOfWeek(date) {
        const days = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
        return days[date.getDay()];
    }

    function updateWorkScheduleTable() {
        const tbody = document.getElementById('workScheduleBody');
        tbody.innerHTML = '';

        selectedWorkDays.forEach(date => {
            const data = workScheduleData[date];
            const row = document.createElement('tr');
            
            // Check if it's a holiday
            const holiday = holidayData[date];
            const isHoliday = holiday && holiday.trangThai === 'NL4';
            
            // Check if it's weekend (Saturday or Sunday)
            const currentDate = new Date(date);
            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
            const isWeekday = currentDate.getDay() >= 1 && currentDate.getDay() <= 5;
            
            // Set row class based on status
            let rowClass = '';
            if (isHoliday) {
                rowClass = 'table-warning'; // Yellow background for holidays
            } else if (data.checkIn && data.checkOut && isWeekday) {
                rowClass = 'table-success'; // Green background for attended weekdays
            }

            row.className = rowClass;
            
            // Determine day type label
            let dayTypeLabel = '';
            if (isHoliday) {
                dayTypeLabel = `<span class="badge bg-warning ms-2">Ngày lễ</span>`;
            } else if (isWeekend) {
                dayTypeLabel = `<span class="badge bg-info ms-2">Cuối tuần</span>`;
            } else {
                dayTypeLabel = `<span class="badge bg-primary ms-2">Ngày thường</span>`;
            }
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="date-checkbox" data-date="${date}" ${data.selected ? 'checked' : ''}>
                </td>
                <td>${getDayOfWeek(currentDate)}</td>
                <td>
                    ${formatDate(new Date(date))}
                    ${dayTypeLabel}
                </td>
                <td>${isWeekday && !isHoliday ? (data.checkIn ? `${data.checkIn} - ${data.checkOut} (${data.totalHours}h)` : '-') : 'Chỉ tăng ca'}</td>
                <td>${data.overtimeHours > 0 ? `${data.overtimeStart} - ${data.overtimeEnd} (${data.overtimeHours}h)` : '-'}</td>
                <td>${data.attendanceNote || '-'}</td>
            `;
            tbody.appendChild(row);
        });

        document.querySelectorAll('.date-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const date = this.dataset.date;
                workScheduleData[date].selected = this.checked;
            });
        });
    }

    function calculateHours(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        let hours = (end - start) / (1000 * 60 * 60);
        if (hours < 0) hours += 24;
        if (hours >= 8) hours -= 2; // Trừ 2 giờ nghỉ trưa nếu làm từ 8 tiếng trở lên
        return Math.max(0, parseFloat(hours.toFixed(2)));
    }

    function updateTotalHours() {
        const checkIn = document.getElementById('checkInTime').value;
        const checkOut = document.getElementById('checkOutTime').value;
        const totalHoursInput = document.getElementById('totalHours');
        if (checkIn && checkOut) {
            const hours = calculateHours(checkIn, checkOut);
            totalHoursInput.value = `${hours}h`;
        } else {
            totalHoursInput.value = '';
        }
    }

    document.getElementById('checkInTime').addEventListener('change', updateTotalHours);
    document.getElementById('checkOutTime').addEventListener('change', updateTotalHours);

    document.getElementById('set8hBtn').addEventListener('click', () => {
        document.getElementById('checkInTime').value = '08:00';
        document.getElementById('checkOutTime').value = '18:00';
        updateTotalHours();
    });

    document.getElementById('cancelOT').addEventListener('click', () => {
        document.getElementById('otStartTime').value = '';
        document.getElementById('otEndTime').value = '';
        document.getElementById('otNote').value = '';
        document.getElementById('overtimeRate').value = '';
    });

    ['1h', '2h', '3h', '4h', '8h'].forEach(hours => {
        document.getElementById(`ot${hours}`).addEventListener('click', () => {
            const overtimeHours = parseInt(hours);
            const selectedDates = Object.entries(workScheduleData)
                .filter(([_, data]) => data.selected)
                .map(([date]) => date);

            if (selectedDates.length === 0) {
                Swal.fire('Lỗi!', 'Vui lòng chọn ít nhất một ngày', 'error');
                return;
            }

            // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày lễ không
            const allHolidays = selectedDates.every(date => 
                holidayData[date] && holidayData[date].trangThai === 'NL4'
            );

            // Kiểm tra xem có phải tất cả các ngày đã chọn đều là cuối tuần không
            const allWeekends = selectedDates.every(date => {
                const dayOfWeek = new Date(date).getDay();
                return dayOfWeek === 0 || dayOfWeek === 6;
            });

            // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày thường không
            const allWeekdays = selectedDates.every(date => {
                const dayOfWeek = new Date(date).getDay();
                return dayOfWeek >= 1 && dayOfWeek <= 5;
            });

            // Tự động chọn tỉ lệ tăng ca dựa trên loại ngày
            let defaultRate = '';
            if (allHolidays) {
                defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Ngày lễ'))?.id;
            } else if (allWeekends) {
                defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Cuối tuần'))?.id;
            } else if (allWeekdays) {
                defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Ngày thường'))?.id;
            } else {
                Swal.fire('Lỗi!', 'Không thể áp dụng tăng ca cho các ngày khác loại', 'error');
                return;
            }

            if (defaultRate) {
                document.getElementById('overtimeRate').value = defaultRate;
                const selectedRate = overtimeRates.find(rate => rate.id == defaultRate);
                if (selectedRate) {
                    document.getElementById('otNote').value = selectedRate.tenTiLeTangCa;
                }
            }

            if (hours === '8h') {
                // Set 8am-6pm with lunch break
                document.getElementById('otStartTime').value = '08:00';
                document.getElementById('otEndTime').value = '18:00';
            } else {
                if (allHolidays || allWeekends) {
                    document.getElementById('otStartTime').value = '08:00';
                    const endTime = addHours('08:00', overtimeHours);
                    if (endTime > '18:00') {
                        Swal.fire('Lỗi!', 'Giờ tăng ca phải trong khoảng từ 08:00 đến 18:00', 'error');
                        return;
                    }
                    document.getElementById('otEndTime').value = endTime;
                } else if (allWeekdays) {
                    document.getElementById('otStartTime').value = '18:00';
                    const endTime = addHours('18:00', overtimeHours);
                    if (endTime > '22:00') {
                        Swal.fire('Lỗi!', 'Giờ tăng ca phải trong khoảng từ 18:00 đến 22:00', 'error');
                        return;
                    }
                    document.getElementById('otEndTime').value = endTime;
                }
            }
            updateOvertime();
        });
    });

    function addHours(time, hours) {
        const [hoursStr, minutesStr] = time.split(':');
        let newHours = parseInt(hoursStr) + hours;
        return `${newHours.toString().padStart(2, '0')}:${minutesStr}`;
    }

    function calculateOvertimeHours(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        let hours = (end - start) / (1000 * 60 * 60);
        if (hours < 0) hours += 24;
        
        // Trừ 2 giờ nghỉ trưa nếu làm từ 8 tiếng trở lên
        if (hours >= 8) {
            hours -= 2;
        }
        
        return Math.max(0, parseFloat(hours.toFixed(2)));
    }

    function calculateRawHours(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        const hours = (end - start) / (1000 * 60 * 60);
        return parseFloat(hours.toFixed(2));
    }

    function updateOvertime() {
        const otStartTime = document.getElementById('otStartTime').value;
        const otEndTime = document.getElementById('otEndTime').value;
        const otRate = document.getElementById('overtimeRate').value;
        const otRawHours = calculateRawHours(otStartTime, otEndTime) || 0;
        const otHours = calculateOvertimeHours(otStartTime, otEndTime) || 0;

        // Lấy các ngày được chọn
        const selectedDates = Object.entries(workScheduleData)
            .filter(([_, data]) => data.selected)
            .map(([date]) => date);

        if (selectedDates.length === 0) {
            Swal.fire('Lỗi!', 'Vui lòng chọn ít nhất một ngày', 'error');
            return;
        }

        // Kiểm tra tỉ lệ tăng ca
        if (!otRate) {
            Swal.fire('Lỗi!', 'Vui lòng chọn tỉ lệ tăng ca', 'error');
            return;
        }

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày lễ không
        const allHolidays = selectedDates.every(date => 
            holidayData[date] && holidayData[date].trangThai === 'NL4'
        );

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là cuối tuần không
        const allWeekends = selectedDates.every(date => {
            const dayOfWeek = new Date(date).getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        });

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày thường không
        const allWeekdays = selectedDates.every(date => {
            const dayOfWeek = new Date(date).getDay();
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        });

        // Tự động gắn tỉ lệ tăng ca dựa trên loại ngày
        let defaultRate = '';
        if (allHolidays) {
            defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Ngày lễ'))?.id;
        } else if (allWeekends) {
            defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Cuối tuần'))?.id;
        } else if (allWeekdays) {
            defaultRate = overtimeRates.find(r => r.tenTiLeTangCa.includes('Ngày thường'))?.id;
        } else {
            Swal.fire('Lỗi!', 'Không thể áp dụng tăng ca cho các ngày khác loại', 'error');
            return;
        }

        if (defaultRate && !otRate) {
            document.getElementById('overtimeRate').value = defaultRate;
            const selectedRate = overtimeRates.find(rate => rate.id == defaultRate);
            if (selectedRate) {
                document.getElementById('otNote').value = selectedRate.tenTiLeTangCa;
            }
        }

        if (allHolidays) {
            // Kiểm tra giới hạn tăng ca cho ngày lễ
            if (otStartTime && (otStartTime < '08:00' || otStartTime > '18:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày lễ phải trong khoảng từ 08:00 đến 18:00', 'error');
                document.getElementById('otStartTime').value = '';
                document.getElementById('otEndTime').value = '';
                return;
            }

            if (otEndTime && (otEndTime < '08:00' || otEndTime > '18:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày lễ phải trong khoảng từ 08:00 đến 18:00', 'error');
                document.getElementById('otEndTime').value = '';
                return;
            }
        } else if (allWeekdays) {
            // Kiểm tra giới hạn tăng ca cho ngày thường (T2-T6)
            if (otStartTime && (otStartTime < '18:00' || otStartTime > '22:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày thường phải bắt đầu từ 18:00', 'error');
                document.getElementById('otStartTime').value = '';
                document.getElementById('otEndTime').value = '';
                return;
            }

            if (otEndTime && (otEndTime < '18:00' || otEndTime > '22:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày thường phải kết thúc trước 22:00', 'error');
                document.getElementById('otEndTime').value = '';
                return;
            }

            // Kiểm tra giới hạn tăng ca cho ngày thường
            if (otRawHours > 4) {
                Swal.fire('Lỗi!', 'Số giờ tăng ca không được vượt quá 4 giờ trong ngày thường', 'error');
                document.getElementById('otEndTime').value = '';
                return;
            }
        } else if (allWeekends) {
            // Kiểm tra giới hạn tăng ca cho cuối tuần (T7-CN)
            if (otStartTime && (otStartTime < '08:00' || otStartTime > '18:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày cuối tuần phải trong khoảng từ 08:00 đến 18:00', 'error');
                document.getElementById('otStartTime').value = '';
                document.getElementById('otEndTime').value = '';
                return;
            }

            if (otEndTime && (otEndTime < '08:00' || otEndTime > '18:00')) {
                Swal.fire('Lỗi!', 'Giờ tăng ca trong ngày cuối tuần phải trong khoảng từ 08:00 đến 18:00', 'error');
                document.getElementById('otEndTime').value = '';
                return;
            }
        }

        // Kiểm tra tổng giờ tăng ca trong tuần cho trạng thái TC3
        const selectedRate = overtimeRates.find(rate => rate.id == otRate);
        if (selectedRate && selectedRate.tenTiLeTangCa.includes('TC3')) {
            // Kiểm tra cho từng ngày được chọn
            for (const date of selectedDates) {
                const weeklyOvertime = calculateWeeklyOvertime(new Date(date), otHours);
                if (weeklyOvertime > 12) {
                    Swal.fire('Lỗi!', 'Tổng số giờ tăng ca trong tuần không được vượt quá 12 giờ cho trạng thái TC3', 'error');
                    document.getElementById('otEndTime').value = '';
                    return;
                }
            }
        }
    }

    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.date-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            const date = checkbox.dataset.date;
            workScheduleData[date].selected = this.checked;
        });
    });

    document.getElementById('submitAll').addEventListener('click', async () => {
        const selectedDates = Object.entries(workScheduleData)
            .filter(([_, data]) => data.selected)
            .map(([date, data]) => ({
                date,
                ...data
            }));

        if (selectedDates.length === 0) {
            Swal.fire('Lỗi!', 'Vui lòng chọn ít nhất một ngày', 'error');
            return;
        }

        // Lọc dữ liệu chấm công chỉ cho T2-T6 và không phải ngày lễ
        const validAttendance = selectedDates
            .filter(date => {
                const dayOfWeek = new Date(date.date).getDay();
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
                const isHoliday = holidayData[date.date] && holidayData[date.date].trangThai === 'NL4';
                return isWeekday && !isHoliday && date.checkIn && date.checkOut;
            })
            .map(date => ({
                NgayLamViec: date.date,
                GioVao: date.checkIn,
                GioRa: date.checkOut,
                TongGio: date.totalHours,
                TrangThai: "LS1",
                GhiChu: date.attendanceNote || ""
            }));

        // Lọc dữ liệu tăng ca hợp lệ
        const validOvertime = selectedDates
            .filter(date => date.overtimeHours > 0 && date.overtimeStart && date.overtimeEnd && date.overtimeRateId)
            .map(date => ({
                NgayTangCa: date.date,
                GioVaoTangCa: date.overtimeStart,
                GioRaTangCa: date.overtimeEnd,
                SoGioTangCa: date.overtimeHours,
                GhiChu: date.overtimeNote || "",
                TiLeTangCa: date.overtimeRateTiLe
            }));

        try {
            const response = await fetch('/api/Attendance/SubmitAttendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    attendance: validAttendance,
                    overtime: validOvertime
                })
            });

            const result = await response.json();
            if (result.success) {
                Swal.fire('Thành công!', 'Lưu dữ liệu thành công', 'success')
                .then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('Lỗi!', result.message, 'error');
            }
        } catch (error) {
            Swal.fire('Lỗi!', 'Có lỗi xảy ra khi lưu dữ liệu', 'error');
        }
    });

    document.getElementById('applyToSelected').addEventListener('click', () => {
        const checkIn = document.getElementById('checkInTime').value;
        const checkOut = document.getElementById('checkOutTime').value;
        const otStartTime = document.getElementById('otStartTime').value;
        const otEndTime = document.getElementById('otEndTime').value;
        const otNote = document.getElementById('otNote').value;
        const attendanceNote = document.getElementById('attendanceNote').value;
        const overtimeRateId = document.getElementById('overtimeRate').value;
        const selectedRate = overtimeRates.find(rate => rate.id == overtimeRateId);

        const otRawHours = calculateRawHours(otStartTime, otEndTime) || 0;
        const otHours = calculateOvertimeHours(otStartTime, otEndTime) || 0;

        const selectedDates = Object.entries(workScheduleData)
            .filter(([_, data]) => data.selected)
            .map(([date]) => date);

        if (selectedDates.length === 0) {
            Swal.fire('Lỗi!', 'Vui lòng chọn ít nhất một ngày', 'error');
            return;
        }

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày lễ không
        const allHolidays = selectedDates.every(date => 
            holidayData[date] && holidayData[date].trangThai === 'NL4'
        );

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là cuối tuần không
        const allWeekends = selectedDates.every(date => {
            const dayOfWeek = new Date(date).getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        });

        // Kiểm tra xem có phải tất cả các ngày đã chọn đều là ngày thường không
        const allWeekdays = selectedDates.every(date => {
            const dayOfWeek = new Date(date).getDay();
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        });

        // Kiểm tra và áp dụng chấm công
        selectedDates.forEach(date => {
            const currentDate = new Date(date);
            const dayOfWeek = currentDate.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isHoliday = holidayData[date] && holidayData[date].trangThai === 'NL4';
            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
            
            if (isHoliday) {
                // Chỉ áp dụng tăng ca cho ngày lễ
                workScheduleData[date] = {
                    ...workScheduleData[date],
                    overtimeHours: otHours,
                    overtimeStart: otStartTime,
                    overtimeEnd: otEndTime,
                    overtimeNote: otNote,
                    overtimeRateId: overtimeRateId || null,
                    overtimeRateTiLe: selectedRate ? selectedRate.tiLe : 1
                };
            } else if (isWeekend) {
                // Chỉ áp dụng tăng ca cho cuối tuần
                workScheduleData[date] = {
                    ...workScheduleData[date],
                    overtimeHours: otHours,
                    overtimeStart: otStartTime,
                    overtimeEnd: otEndTime,
                    overtimeNote: otNote,
                    overtimeRateId: overtimeRateId || null,
                    overtimeRateTiLe: selectedRate ? selectedRate.tiLe : 1
                };
            } else if (isWeekday) {
                // Áp dụng cả chấm công và tăng ca cho ngày thường
                workScheduleData[date] = {
                    ...workScheduleData[date],
                    checkIn: checkIn,
                    checkOut: checkOut,
                    totalHours: checkIn && checkOut ? calculateHours(checkIn, checkOut) : 0,
                    overtimeHours: otHours,
                    overtimeStart: otStartTime,
                    overtimeEnd: otEndTime,
                    overtimeNote: otNote,
                    attendanceNote: attendanceNote,
                    overtimeRateId: overtimeRateId || null,
                    overtimeRateTiLe: selectedRate ? selectedRate.tiLe : 1
                };
            }
        });

        updateWorkScheduleTable();

        // Reset form
        document.getElementById('checkInTime').value = '';
        document.getElementById('checkOutTime').value = '';
        document.getElementById('totalHours').value = '';
        document.getElementById('otStartTime').value = '';
        document.getElementById('otEndTime').value = '';
        document.getElementById('otNote').value = '';
        document.getElementById('attendanceNote').value = '';
        document.getElementById('overtimeRate').value = '';

        selectedDates.forEach(date => {
            workScheduleData[date].selected = false;
        });
        document.getElementById('selectAll').checked = false;

        updateWorkScheduleTable();

        Swal.fire('Thành công!', 'Đã áp dụng dữ liệu cho các ngày đã chọn', 'success');
    });

    // Thêm hàm kiểm tra tổng giờ tăng ca trong tuần
    function getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function calculateWeeklyOvertime(date, overtimeHours) {
        const weekNumber = getWeekNumber(new Date(date));
        const weekStart = new Date(date);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        let totalWeeklyOvertime = overtimeHours;
        Object.entries(workScheduleData).forEach(([dateStr, data]) => {
            const currentDate = new Date(dateStr);
            if (currentDate >= weekStart && currentDate <= weekEnd && dateStr !== date) {
                totalWeeklyOvertime += data.overtimeHours || 0;
            }
        });
        return totalWeeklyOvertime;
    }

    window.addEventListener('load', loadOvertimeRates);
</script>

<style>
    .table-warning {
        background-color: #fff3cd !important;
    }
    .table-success {
        background-color: #d1e7dd !important;
    }
    .badge {
        font-size: 0.8em;
    }
</style>