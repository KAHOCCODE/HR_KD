@{
    Layout = "~/Views/Shared/_ThemeLayout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Nhân Viên Mới</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/createemploy.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card shadow border-0 overflow-hidden">
            <div class="card-header bg-primary text-white p-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-plus fa-2x me-3"></i>
                    <h2 class="mb-0 fw-bold">Thêm Nhân Viên Mới</h2>
                </div>
            </div>
            
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" 
                     id="formProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>

            <div class="card-body p-4">
                <a href="~/EmployeeImport/Index" class="text-decoration-none">
                    <div class="card border-0 shadow-sm mb-4 bg-info bg-opacity-10 hover-shadow transition" style="cursor: pointer;">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="text-info fw-bold mb-1">
                                    <i class="fa fa-file-excel me-2"></i>Nhập Excel Danh Sách Nhân Viên
                                </h5>
                                <p class="mb-0 text-secondary">Tải file mẫu và import danh sách nhân viên hàng loạt dễ dàng.</p>
                            </div>
                            <div>
                                <button class="btn btn-outline-info btn-lg">
                                    <i class="fa fa-arrow-right me-2"></i>Đi tới Import
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
                <form id="createEmployeeForm" class="needs-validation" novalidate>
                    <div class="row g-4">
                        <!-- Left Column -->
                        <div class="col-lg-8">
                            <!-- Thông tin cá nhân -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-id-card me-2"></i>Thông Tin Cá Nhân
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <!-- Họ và Tên -->
                                        <div class="col-md-6">
                                            <label for="HoTen" class="form-label">
                                                <i class="fas fa-user me-1 text-muted"></i>Họ và Tên <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="HoTen" required />
                                            <div class="invalid-feedback">Vui lòng nhập họ và tên</div>
                                        </div>

                                        <!-- Ngày Sinh -->
                                        <div class="col-md-6">
                                            <label for="NgaySinh" class="form-label">
                                                <i class="fas fa-birthday-cake me-1 text-muted"></i>Ngày Sinh <span class="text-danger">*</span>
                                            </label>
                                            <input type="date" class="form-control form-control-lg" id="NgaySinh" required />
                                            <div class="invalid-feedback">Vui lòng chọn ngày sinh</div>
                                        </div>

                                        <!-- Giới Tính -->
                                        <div class="col-md-6">
                                            <label for="GioiTinh" class="form-label">
                                                <i class="fas fa-venus-mars me-1 text-muted"></i>Giới Tính <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select form-select-lg" id="GioiTinh" required>
                                                <option value="">-- Chọn giới tính --</option>
                                                <option value="true">Nam</option>
                                                <option value="false">Nữ</option>
                                            </select>
                                            <div class="invalid-feedback">Vui lòng chọn giới tính</div>
                                        </div>

                                        <!-- Trình Độ Học Vấn -->
                                        <div class="col-md-6">
                                            <label for="TrinhDoHocVan" class="form-label">
                                                <i class="fas fa-graduation-cap me-1 text-muted"></i>Trình Độ Học Vấn
                                            </label>
                                            <select class="form-select form-select-lg" id="TrinhDoHocVan">
                                                <option value="">-- Chọn trình độ --</option>
                                                <option value="Trung học">Trung học</option>
                                                <option value="Cao đẳng">Cao đẳng</option>
                                                <option value="Đại học">Đại học</option>
                                                <option value="Thạc sĩ">Thạc sĩ</option>
                                                <option value="Tiến sĩ">Tiến sĩ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Thông tin liên hệ -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-address-book me-2"></i>Thông Tin Liên Hệ
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <!-- Email -->
                                        <div class="col-md-6">
                                            <label for="Email" class="form-label">
                                                <i class="fas fa-envelope me-1 text-muted"></i>Email <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text bg-light"><i class="fas fa-at"></i></span>
                                                <input type="email" class="form-control" id="Email" required />
                                            </div>
                                            <div class="invalid-feedback">Vui lòng nhập email hợp lệ</div>
                                        </div>

                                        <!-- Số Điện Thoại -->
                                        <div class="col-md-6">
                                            <label for="Sdt" class="form-label">
                                                <i class="fas fa-phone me-1 text-muted"></i>Số Điện Thoại <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text bg-light"><i class="fas fa-phone"></i></span>
                                                <input type="text" class="form-control" id="Sdt" required />
                                            </div>
                                            <div class="invalid-feedback">Vui lòng nhập số điện thoại</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Địa chỉ -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-map-marker-alt me-2"></i>Địa Chỉ
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <!-- Tỉnh/Thành phố -->
                                        <div class="col-md-6">
                                            <label for="TinhThanh" class="form-label">
                                                <i class="fas fa-city me-1 text-muted"></i>Tỉnh/Thành phố
                                            </label>
                                            <select class="form-select form-select-lg" id="TinhThanh">
                                                <option value="">-- Chọn Tỉnh/Thành phố --</option>
                                            </select>
                                        </div>

                                        <!-- Quận/Huyện -->
                                        <div class="col-md-6">
                                            <label for="QuanHuyen" class="form-label">
                                                <i class="fas fa-building me-1 text-muted"></i>Quận/Huyện
                                            </label>
                                            <select class="form-select form-select-lg" id="QuanHuyen">
                                                <option value="">-- Chọn Quận/Huyện --</option>
                                            </select>
                                        </div>

                                        <!-- Phường/Xã -->
                                        <div class="col-md-6">
                                            <label for="PhuongXa" class="form-label">
                                                <i class="fas fa-home me-1 text-muted"></i>Phường/Xã
                                            </label>
                                            <select class="form-select form-select-lg" id="PhuongXa">
                                                <option value="">-- Chọn Phường/Xã --</option>
                                            </select>
                                        </div>

                                        <!-- Số nhà, đường -->
                                        <div class="col-md-6">
                                            <label for="SoNhaDuong" class="form-label">
                                                <i class="fas fa-road me-1 text-muted"></i>Số nhà, đường
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="SoNhaDuong" />
                                        </div>

                                        <!-- Địa chỉ đầy đủ -->
                                        <div class="col-12">
                                            <label for="DiaChiDayDu" class="form-label">
                                                <i class="fas fa-map me-1 text-muted"></i>Địa Chỉ Đầy Đủ
                                            </label>
                                            <textarea class="form-control bg-light" id="DiaChiDayDu" rows="2" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-lg-4">
                            <!-- Ảnh đại diện -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-image me-2"></i>Ảnh Đại Diện
                                    </h5>
                                </div>
                                <div class="card-body p-4 text-center">
                                    <div class="avatar-upload mb-3">
                                        <div class="avatar-preview rounded-circle mx-auto mb-3" style="width: 180px; height: 180px; overflow: hidden; border: 3px solid #eee;">
                                            <img id="avatarPreview" src="/api/placeholder/180/180" class="w-100 h-100" style="object-fit: cover;" alt="Avatar Preview" />
                                        </div>
                                        <label for="AvatarUrl" class="btn btn-outline-primary">
                                            <i class="fas fa-upload me-2"></i>Chọn ảnh
                                        </label>
                                        <input type="file" class="form-control d-none" id="AvatarUrl" name="AvatarUrl" accept=".jpg,.png,.jpeg" onchange="previewAvatar(this)" />
                                        <div class="small text-muted mt-2">Định dạng: JPG, PNG (Tối đa 5MB)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Thông tin công việc -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-briefcase me-2"></i>Thông Tin Công Việc
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <label for="NgayVaoLam" class="form-label">
                                            <i class="fas fa-calendar-check me-1 text-muted"></i>Ngày Vào Làm <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control form-control-lg" id="NgayVaoLam" required />
                                        <div class="invalid-feedback">Vui lòng chọn ngày vào làm</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="MaChucVu" class="form-label">
                                            <i class="fas fa-user-tie me-1 text-muted"></i>Chức Vụ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select form-select-lg" id="MaChucVu" required>
                                            <option value="">-- Chọn chức vụ --</option>
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn chức vụ</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="MaPhongBan" class="form-label">
                                            <i class="fas fa-sitemap me-1 text-muted"></i>Phòng Ban <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select form-select-lg" id="MaPhongBan" required>
                                            <option value="">-- Chọn phòng ban --</option>
                                        </select>
                                        <div class="invalid-feedback">Vui lòng chọn phòng ban</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nút Submit -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-light btn-lg me-2">
                            <i class="fas fa-times me-2"></i>Hủy
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-save me-2"></i>Lưu & Tiếp Tục
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tooltip Card -->
        <div class="card border-0 shadow-sm mt-4 bg-light">
            <div class="card-body p-3 d-flex align-items-center">
                <i class="fas fa-info-circle text-primary me-3 fa-2x"></i>
                <div>
                    <p class="mb-0">Sau khi thêm nhân viên thành công, bạn sẽ được chuyển đến trang <strong>Thiết lập Lương</strong> cho nhân viên này.</p>
                </div>
            </div>
        </div>
    </div>

 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.0/sweetalert2.all.min.js"></script>

    <script>
        $(document).ready(function () {
            // Theo dõi tiến trình điền form
            updateProgress();
            $('input, select').on('change', updateProgress);

            // Bootstrap form validation
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        highlightFirstError();
                    } else {
                        submitForm(event);
                    }
                    form.classList.add('was-validated');
                }, false);
            });

            // Highlight first error with smooth scroll
            function highlightFirstError() {
                const firstInvalid = document.querySelector('.form-control:invalid, .form-select:invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add attention animation
                    firstInvalid.classList.add('attention');
                    setTimeout(() => {
                        firstInvalid.classList.remove('attention');
                    }, 1000);
                }
            }

            // Update progress bar
            function updateProgress() {
                const requiredFields = $('#createEmployeeForm [required]');
                const filledFields = requiredFields.filter((i, field) => $(field).val() !== '');
                const progressPercentage = (filledFields.length / requiredFields.length) * 100;
                
                $('#formProgress').css('width', progressPercentage + '%');
                $('#formProgress').attr('aria-valuenow', progressPercentage);
                
                // Change color based on progress
                if (progressPercentage < 33) {
                    $('#formProgress').removeClass('bg-warning bg-success').addClass('bg-danger');
                } else if (progressPercentage < 66) {
                    $('#formProgress').removeClass('bg-danger bg-success').addClass('bg-warning');
                } else {
                    $('#formProgress').removeClass('bg-danger bg-warning').addClass('bg-success');
                }
            }

            // Load danh sách chức vụ
            $.get("/api/ChucVuApi", function (data) {
                let dropdown = $("#MaChucVu");
                dropdown.html('<option value="">-- Chọn chức vụ --</option>');
                data.forEach(item => {
                    dropdown.append(`<option value="${item.maChucVu}">${item.tenChucVu}</option>`);
                });
            });

            // Load danh sách phòng ban
            $.get("/api/PhongBanApi", function (data) {
                let dropdown = $("#MaPhongBan");
                dropdown.html('<option value="">-- Chọn phòng ban --</option>');
                data.forEach(item => {
                    dropdown.append(`<option value="${item.maPhongBan}">${item.tenPhongBan}</option>`);
                });
            });

            // Load danh sách Tỉnh/Thành phố từ API
            $.get("https://provinces.open-api.vn/api/p/", function (data) {
                let tinhThanhDropdown = $("#TinhThanh");
                tinhThanhDropdown.html('<option value="">-- Chọn Tỉnh/Thành phố --</option>');
                data.forEach(item => {
                    tinhThanhDropdown.append(`<option value="${item.code}" data-name="${item.name}">${item.name}</option>`);
                });
            });

            // Khi chọn Tỉnh/Thành phố, load Quận/Huyện
            $("#TinhThanh").change(function () {
                let tinhThanhCode = $(this).val();
                let quanHuyenDropdown = $("#QuanHuyen");
                let phuongXaDropdown = $("#PhuongXa");

                // Reset Quận/Huyện và Phường/Xã
                quanHuyenDropdown.html('<option value="">-- Chọn Quận/Huyện --</option>');
                phuongXaDropdown.html('<option value="">-- Chọn Phường/Xã --</option>');

                if (tinhThanhCode) {
                    $.get(`https://provinces.open-api.vn/api/p/${tinhThanhCode}?depth=2`, function (data) {
                        data.districts.forEach(item => {
                            quanHuyenDropdown.append(`<option value="${item.code}" data-name="${item.name}">${item.name}</option>`);
                        });
                    });
                }
                updateDiaChiDayDu();
            });

            // Khi chọn Quận/Huyện, load Phường/Xã
            $("#QuanHuyen").change(function () {
                let quanHuyenCode = $(this).val();
                let phuongXaDropdown = $("#PhuongXa");

                // Reset Phường/Xã
                phuongXaDropdown.html('<option value="">-- Chọn Phường/Xã --</option>');

                if (quanHuyenCode) {
                    $.get(`https://provinces.open-api.vn/api/d/${quanHuyenCode}?depth=2`, function (data) {
                        data.wards.forEach(item => {
                            phuongXaDropdown.append(`<option value="${item.code}" data-name="${item.name}">${item.name}</option>`);
                        });
                    });
                }
                updateDiaChiDayDu();
            });

            // Khi chọn Phường/Xã hoặc nhập Số nhà, đường, cập nhật địa chỉ đầy đủ
            $("#PhuongXa, #SoNhaDuong").on("change input", function () {
                updateDiaChiDayDu();
            });

            // Hàm cập nhật địa chỉ đầy đủ
            function updateDiaChiDayDu() {
                let soNhaDuong = $("#SoNhaDuong").val();
                let phuongXa = $("#PhuongXa option:selected").data("name") || "";
                let quanHuyen = $("#QuanHuyen option:selected").data("name") || "";
                let tinhThanh = $("#TinhThanh option:selected").data("name") || "";

                let diaChiDayDu = [soNhaDuong, phuongXa, quanHuyen, tinhThanh]
                    .filter(part => part) // Loại bỏ phần rỗng
                    .join(", ");

                $("#DiaChiDayDu").val(diaChiDayDu);
            }

            // Gửi form 
            function submitForm(e) {
                e.preventDefault();

                // Hiển thị loading
                Swal.fire({
                    title: 'Đang xử lý...',
                    html: 'Vui lòng chờ trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Tạo FormData cho nhân viên
                let formData = new FormData();
                formData.append("HoTen", $("#HoTen").val());
                formData.append("NgaySinh", $("#NgaySinh").val());
                formData.append("GioiTinh", $("#GioiTinh").val());
                formData.append("DiaChi", $("#DiaChiDayDu").val());
                formData.append("Sdt", $("#Sdt").val());
                formData.append("Email", $("#Email").val());
                formData.append("TrinhDoHocVan", $("#TrinhDoHocVan").val());
                formData.append("MaChucVu", $("#MaChucVu").val());
                formData.append("MaPhongBan", $("#MaPhongBan").val());
                formData.append("NgayVaoLam", $("#NgayVaoLam").val());
                let avatar = $("#AvatarUrl")[0].files[0];
                if (avatar) {
                    formData.append("AvatarUrl", avatar);
                }

                // Gửi dữ liệu nhân viên qua API
                $.ajax({
                    url: "/api/EmployeesApi/CreateEmployee",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        // Lấy maNv từ response
                        let maNv = response.maNv;
                        if (!maNv) {
                            Swal.fire({
                                icon: "error",
                                title: "Lỗi!",
                                text: "Không thể lấy mã nhân viên từ response."
                            });
                            return;
                        }

                        Swal.fire({
                            icon: "success",
                            title: "Thành công!",
                            text: "Nhân viên đã được thêm thành công!",
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            // Chuyển hướng đến trang SetupSalary với maNv
                            window.location.href = `/Employees/SetupSalary?maNv=${maNv}`;
                        });
                    },
                    error: function (xhr) {
                        console.log("Error Response:", xhr);
                        let errorMessage = "Lỗi không xác định!";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            errorMessage = xhr.responseText;
                        }
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi!",
                            text: errorMessage
                        });
                    }
                });
            }
        });

        // Hiển thị ảnh xem trước
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#avatarPreview').attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>