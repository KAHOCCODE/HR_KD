@{
    Layout = "~/Views/Shared/_ThemeLayout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-700 to-indigo-700 px-6 py-5">
                <h2 class="text-2xl font-semibold text-white text-center">
                    <i class="fas fa-file-contract mr-2"></i>
                    Thiết Lập Hợp Đồng
                </h2>
            </div>

            <div class="p-6 bg-gray-50 border-b border-gray-200">
                <div class="progress h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="formProgress" class="h-full bg-blue-500 transition-all duration-500 ease-in-out"
                         style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="flex justify-between mt-3 text-sm font-medium text-gray-600">
                    <span>Thông tin hợp đồng</span>
                    <span>Hoàn tất</span>
                </div>
            </div>

            <form id="contractForm" class="p-6 sm:p-8">
                <input type="hidden" id="MaNv" />
                <input type="hidden" id="MaHopDong" />

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                <i class="fas fa-file-contract mr-2 text-blue-600"></i>
                                Thông tin hợp đồng
                            </h3>

                            <div class="space-y-5">
                                <div>
                                    <label for="MaLoaiHopDong" class="block text-sm font-medium text-gray-700">
                                        Loại Hợp Đồng <span class="text-red-500">*</span>
                                    </label>
                                    <select id="MaLoaiHopDong"
                                            class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                            required>
                                        <option value="">-- Chọn loại hợp đồng --</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500">Chọn loại hợp đồng phù hợp</p>
                                </div>

                                <div id="ThoiHanContainer">
                                    <label for="ThoiHan" class="block text-sm font-medium text-gray-700">
                                        Thời Hạn (tháng)
                                    </label>
                                    <input type="number" id="ThoiHan" min="0"
                                           class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                           placeholder="Nhập thời hạn hợp đồng" />
                                    <p class="mt-1 text-xs text-gray-500">Thời hạn hợp đồng (nếu có)</p>
                                </div>

                                <div>
                                    <label for="NgayBatDau" class="block text-sm font-medium text-gray-700">
                                        Ngày Bắt Đầu <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="NgayBatDau"
                                           class="flatpickr w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                           placeholder="Chọn ngày" required />
                                    <p class="mt-1 text-xs text-gray-500">Ngày bắt đầu hiệu lực hợp đồng</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                                Chi tiết bổ sung
                            </h3>

                            <div class="space-y-5">
                                <div>
                                    <label for="NgayKetThuc" class="block text-sm font-medium text-gray-700">
                                        Ngày Kết Thúc
                                    </label>
                                    <input type="text" id="NgayKetThuc"
                                           class="w-full px-4 py-2.5 rounded-lg border border-gray-300 bg-gray-100 text-gray-600"
                                           readonly />
                                    <p class="mt-1 text-xs text-gray-500">Ngày kết thúc (tự động tính)</p>
                                </div>

                                <div>
                                    <label for="GhiChu" class="block text-sm font-medium text-gray-700">
                                        Ghi Chú
                                    </label>
                                    <textarea id="GhiChu" rows="4"
                                              class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                              placeholder="Thông tin bổ sung"></textarea>
                                    <p class="mt-1 text-xs text-gray-500">Thông tin bổ sung về hợp đồng</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="mt-8 flex justify-between">
                    <a href="/Employees/EmployeeContracts"
                       class="inline-flex items-center px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Quay Lại
                    </a>
                    <button type="submit"
                            class="inline-flex items-center px-6 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-save mr-2"></i>
                        Lưu Hợp Đồng
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        $(document).ready(function () {
            // Lấy maNv từ query string
            const urlParams = new URLSearchParams(window.location.search);
            const maNv = urlParams.get('maNv');
            $("#MaNv").val(maNv);

            // Initialize Flatpickr
            flatpickr("#NgayBatDau", {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                minDate: "today",
                defaultDate: "today",
                onReady: function(selectedDates, dateStr, instance) {
                    $(instance.input).removeAttr("disabled").removeAttr("readonly");
                    instance.altInput.setAttribute("placeholder", "dd/mm/yyyy");
                },
                onOpen: function(selectedDates, dateStr, instance) {
                    instance.calendarContainer.style.zIndex = "9999";
                }
            });

            // Load danh sách loại hợp đồng
            $.get("/api/LoaiHopDongApi", function (data) {
                let dropdown = $("#MaLoaiHopDong");
                dropdown.html('<option value="">-- Chọn loại hợp đồng --</option>');
                data.forEach(item => {
                    dropdown.append(`<option value="${item.maLoaiHopDong}" data-thoihan="${item.thoiHanMacDinh || ''}">${item.tenLoaiHopDong}</option>`);
                });
            });

            // Xử lý khi chọn loại hợp đồng
            $("#MaLoaiHopDong").change(function () {
                let thoiHanMacDinh = $(this).find(':selected').data('thoihan');
                let thoiHanInput = $("#ThoiHan");
                let thoiHanContainer = $("#ThoiHanContainer");
                let maLoaiHopDong = $(this).val();

                // Nếu là hợp đồng không xác định thời hạn (MaLoaiHopDong = 2)
                if (maLoaiHopDong == 2) {
                    thoiHanContainer.hide();
                    thoiHanInput.val('');
                    thoiHanInput.removeAttr('max');
                    thoiHanInput.removeAttr('data-thoihan-mac-dinh');
                    $("#NgayKetThuc").val(''); // Xóa ngày kết thúc
                } else if (thoiHanMacDinh) {
                    thoiHanContainer.show();
                    thoiHanInput.val(thoiHanMacDinh);
                    thoiHanInput.attr('max', thoiHanMacDinh);
                    thoiHanInput.attr('data-thoihan-mac-dinh', thoiHanMacDinh);
                } else {
                    thoiHanContainer.hide();
                    thoiHanInput.val('');
                    thoiHanInput.removeAttr('max');
                    thoiHanInput.removeAttr('data-thoihan-mac-dinh');
                }
                updateNgayKetThuc();
            });

            // Cập nhật ngày kết thúc
            $("#NgayBatDau, #ThoiHan").on("change input", updateNgayKetThuc);

            function updateNgayKetThuc() {
                let maLoaiHopDong = $("#MaLoaiHopDong").val();
                let ngayBatDau = $("#NgayBatDau").val();
                let thoiHan = parseInt($("#ThoiHan").val()) || 0;

                // Nếu là hợp đồng không xác định thời hạn, không cần ngày kết thúc
                if (maLoaiHopDong == 2) {
                    $("#NgayKetThuc").val('');
                } else if (ngayBatDau && thoiHan > 0) {
                    let startDate = new Date(ngayBatDau);
                    let endDate = new Date(startDate.setMonth(startDate.getMonth() + thoiHan));
                    let formattedEndDate = endDate.toISOString().split('T')[0];
                    $("#NgayKetThuc").val(formattedEndDate);
                } else {
                    $("#NgayKetThuc").val('');
                }
            }

            // Load thông tin hợp đồng hiện tại (nếu có)
            if (maNv) {
                $.get(`/api/EmployeesApi/GetEmployeeContract/${maNv}`, function (data) {
                    if (data && data.maHopDong) {
                        $("#MaHopDong").val(data.maHopDong);
                        $("#MaLoaiHopDong").val(data.maLoaiHopDong).trigger('change');
                        $("#ThoiHan").val(data.thoiHan);
                        $("#NgayBatDau").val(data.ngayBatDau ? new Date(data.ngayBatDau).toISOString().split('T')[0] : '');
                        $("#NgayKetThuc").val(data.ngayKetThuc ? new Date(data.ngayKetThuc).toISOString().split('T')[0] : '');
                        $("#GhiChu").val(data.ghiChu);
                    }
                }).fail(function () {
                    Swal.fire({
                        icon: "error",
                        title: "Lỗi!",
                        text: "Không thể tải thông tin hợp đồng.",
                        confirmButtonColor: "#2563eb"
                    });
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Lỗi!",
                    text: "Không tìm thấy mã nhân viên.",
                    confirmButtonColor: "#2563eb"
                });
            }

            // Update progress bar
            function updateProgressBar() {
                let requiredFields = ["MaLoaiHopDong", "NgayBatDau"];
                let filledCount = 0;

                requiredFields.forEach(field => {
                    if ($("#" + field).val()) filledCount++;
                });

                let optionalFields = ["ThoiHan", "GhiChu"];
                optionalFields.forEach(field => {
                    if ($("#" + field).val() && $("#" + field).val() !== "0") {
                        filledCount += 0.5;
                    }
                });

                let progressPercent = Math.min(100, Math.round((filledCount / (requiredFields.length + 1)) * 100));
                $("#formProgress").css("width", progressPercent + "%").attr("aria-valuenow", progressPercent);
            }

            // Form input handlers
            $("#MaLoaiHopDong, #NgayBatDau, #ThoiHan, #GhiChu").on("change input keyup", updateProgressBar);

            // Form submission
            $("#contractForm").submit(function (e) {
                e.preventDefault();

                // Progress bar animation
                $("#formProgress").css({
                    "width": "100%",
                    "transition": "width 0.8s ease-in-out"
                });

                // Validate required fields
                let requiredFields = [
                    { id: "MaLoaiHopDong", name: "Loại Hợp Đồng" },
                    { id: "NgayBatDau", name: "Ngày Bắt Đầu" }
                ];

                for (let field of requiredFields) {
                    if (!$("#" + field.id).val()) {
                        Swal.fire({
                            icon: "warning",
                            title: "Thiếu thông tin",
                            text: `Vui lòng nhập ${field.name}!`,
                            confirmButtonColor: "#2563eb"
                        });
                        return;
                    }
                }

                // Validate thời hạn (chỉ áp dụng cho hợp đồng không phải không xác định thời hạn)
                let maLoaiHopDong = $("#MaLoaiHopDong").val();
                let thoiHan = parseInt($("#ThoiHan").val()) || 0;
                let thoiHanMacDinh = parseInt($("#ThoiHan").attr('data-thoihan-mac-dinh')) || 0;

                if (maLoaiHopDong != 2 && thoiHanMacDinh && thoiHan > thoiHanMacDinh) {
                    Swal.fire({
                        icon: "warning",
                        title: "Thời hạn không hợp lệ",
                        text: `Thời hạn hợp đồng không được vượt quá ${thoiHanMacDinh} tháng!`,
                        confirmButtonColor: "#2563eb"
                    });
                    return;
                }

                // Prepare data
                let formData = {
                    MaNv: maNv ? parseInt(maNv) : 0,
                    MaHopDong: $("#MaHopDong").val() || 0,
                    MaLoaiHopDong: parseInt($("#MaLoaiHopDong").val()),
                    ThoiHan: maLoaiHopDong == 2 ? null : thoiHan, // Gửi null nếu là hợp đồng không xác định thời hạn
                    NgayBatDau: $("#NgayBatDau").val(),
                    NgayKetThuc: maLoaiHopDong == 2 ? null : $("#NgayKetThuc").val() || null, // Gửi null nếu là hợp đồng không xác định thời hạn
                    GhiChu: $("#GhiChu").val()
                };

                // Validate MaNv
                if (!formData.MaNv) {
                    Swal.fire({
                        icon: "error",
                        title: "Lỗi!",
                        text: "Mã nhân viên không hợp lệ.",
                        confirmButtonColor: "#2563eb"
                    });
                    return;
                }

                // Show loading
                Swal.fire({
                    title: "Đang xử lý...",
                    text: "Vui lòng chờ trong giây lát",
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // API call to save contract
                $.ajax({
                    url: "/api/EmployeesApi/SaveContract",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        // Sau khi lưu hợp đồng thành công, kiểm tra thông tin lương
                        $.get(`/api/EmployeesApi/CheckEmployeeSalary/${formData.MaNv}`, function (salaryData) {
                            Swal.fire({
                                icon: "success",
                                title: "Thành công!",
                                text: "Hợp đồng đã được lưu thành công!",
                                confirmButtonColor: "#2563eb",
                                timer: 2000,
                                timerProgressBar: true
                            }).then(() => {
                                // Nếu nhân viên chưa có thông tin lương, chuyển hướng đến SetupSalary
                                if (!salaryData.hasSalary) {
                                    window.location.href = `/Employees/SetupSalary?maNv=${formData.MaNv}`;
                                } else {
                                    // Nếu đã có thông tin lương, chuyển hướng về EmployeeContracts
                                    window.location.href = "/Employees/EmployeeContracts";
                                }
                            });
                        }).fail(function () {
                            Swal.fire({
                                icon: "error",
                                title: "Lỗi!",
                                text: "Không thể kiểm tra thông tin lương.",
                                confirmButtonColor: "#2563eb"
                            });
                        });
                    },
                    error: function (xhr) {
                        let errorMessage = xhr.responseJSON?.message || xhr.responseText || "Lỗi không xác định!";
                        Swal.fire({
                            icon: "error",
                            title: "Lỗi!",
                            text: errorMessage,
                            confirmButtonColor: "#2563eb"
                        });
                    }
                });
            });

            // Initialize progress bar
            updateProgressBar();
        });
    </script>
}