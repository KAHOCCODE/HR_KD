@{
    Layout = "~/Views/Shared/_ThemeLayout.cshtml";
    ViewData["Title"] = "Quản lý bảng lương theo phòng ban";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container py-4">
    <h2 class="text-2xl font-bold mb-4">Quản lý bảng lương theo phòng ban</h2>

    <div class="mb-3">
        <label class="form-label">Chọn tháng/năm:</label>
        <div class="d-flex gap-2">
            <select id="monthSelect" class="form-select w-auto">
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" selected="@(i == DateTime.Now.Month ? "selected" : null)">Tháng @i</option>
                }
            </select>
            <select id="yearSelect" class="form-select w-auto">
                @for (int i = 2020; i <= DateTime.Now.Year + 1; i++)
                {
                    <option value="@i" selected="@(i == DateTime.Now.Year ? "selected" : null)">@i</option>
                }
            </select>
            <button class="btn btn-primary" onclick="loadPayrollStatus()">Tải dữ liệu</button>
        </div>
    </div>

    <div id="payrollContainer"></div>
</div>

<div class="modal fade" id="createPayrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo bảng lương</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có muốn tạo bảng lương cho <strong id="modalEmployeeName"></strong> không?</p>
                <input type="hidden" id="modalMaNv" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-primary" onclick="confirmCreatePayroll()">Tạo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewPayrollModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết bảng lương</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="payrollDetailContainer" class="space-y-2 text-sm">
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        function loadPayrollStatus() {
            const year = $('#yearSelect').val();
            const month = $('#monthSelect').val();

            $.get(`/api/PayrollApi/GetPayrollStatus?year=${year}&month=${month}`, function (result) {
                let html = '';
                result.forEach(pb => {
                    html += `<div class="bg-white border border-gray-200 rounded p-3 mb-4 shadow-sm">
                                            <h4 class="text-lg font-semibold mb-3 text-indigo-600">${pb.tenPhongBan}</h4>
                                            <div class="row">`;

                    pb.nhanViens.forEach(nv => {
                        html += `<div class="col-md-6 mb-3">
                                                <div class="p-3 border rounded shadow-sm d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="fw-semibold">${nv.hoTen}</div>
                                                        <div class="text-muted">${nv.coBangLuong ? 'Đã có bảng lương' : 'Chưa có bảng lương'}</div>
                                                    </div>
                                                    <div>
                                                        ${nv.coBangLuong
                                ? `<button class="btn btn-outline-primary btn-sm" onclick="openPayrollDetail(${nv.maNv})">Xem</button>`
                                : `<button class="btn btn-success btn-sm" onclick="openCreateModal(${nv.maNv}, '${nv.hoTen}')">Tạo</button>`}
                                                    </div>
                                                </div>
                                            </div>`;
                    });

                    html += `</div></div>`;
                });

                $('#payrollContainer').html(html);
            });
        }

        function openCreateModal(maNv, hoTen) {
            $('#modalMaNv').val(maNv);
            $('#modalEmployeeName').text(hoTen);
            const modal = new bootstrap.Modal(document.getElementById('createPayrollModal'));
            modal.show();
        }

        function confirmCreatePayroll() {
            const maNv = $('#modalMaNv').val();
            const year = $('#yearSelect').val();
            const month = $('#monthSelect').val();

            $.post(`/api/PayrollApi/CreateOrGetPayroll?maNv=${maNv}&year=${year}&month=${month}`, function (response) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createPayrollModal'));
                modal.hide();
                loadPayrollStatus();
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: `Đã tạo bảng lương cho nhân viên có mã ${maNv} tháng ${month}/${year}.`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }).fail(function (xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: xhr.responseText
                });
            });
        }

        function openPayrollDetail(maNv) {
            const year = $('#yearSelect').val();
            const month = $('#monthSelect').val();

            $.get(`/api/PayrollApi/GetPayrollDetail/${maNv}`, function (data) {
                const html = `
                                            <div><strong>Họ tên:</strong> ${data.hoTen}</div>
                                            <div><strong>Tháng:</strong> ${new Date(data.thangNam).toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' })}</div>
                                            <hr />
                                            <div><strong>Lương thêm:</strong> ${data.luongThem?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            <div><strong>Phụ cấp thêm:</strong> ${data.phuCapThem?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            <div><strong>Lương tăng ca:</strong> ${data.luongTangCa?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            <div><strong>Thuế TNCN:</strong> -${data.thueTNCN?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            <hr />
                                            <div><strong>Tổng lương:</strong> ${data.tongLuong?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            <div class="fw-bold text-lg text-success"><strong>Lương thực lãnh:</strong> ${data.thucNhan?.toLocaleString('vi-VN') ?? 0} VND</div>
                                            ${data.ghiChu ? `<div><strong>Ghi chú:</strong> ${data.ghiChu}</div>` : ''}
                                        `;

                $('#payrollDetailContainer').html(html);
                const modal = new bootstrap.Modal(document.getElementById('viewPayrollModal'));
                modal.show();
            }).fail(function (xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: xhr.responseText
                });
            });
        }

        // Load mặc định khi mở trang
        $(document).ready(function () {
            loadPayrollStatus();
        });
    </script>
}