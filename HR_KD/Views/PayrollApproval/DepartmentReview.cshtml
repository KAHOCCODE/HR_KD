@{
    Layout = "~/Views/Shared/_ThemeLayout.cshtml";
    ViewData["Title"] = "Rà soát bảng lương phòng ban";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container py-4">
    <h2 class="text-2xl font-bold mb-4">Rà soát bảng lương phòng ban</h2>

    <div class="mb-3">
        <label class="form-label">Chọn tháng/năm:</label>
        <div class="d-flex gap-2">
            <select id="monthSelect" class="form-select w-auto">
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" selected="@(i == DateTime.Now.Month ? "selected" : null)">Tháng @i</option>
                }
            </select>
            <select id="yearSelect" class="form-select w-auto">
                @for (int i = 2020; i <= DateTime.Now.Year + 1; i++)
                {
                    <option value="@i" selected="@(i == DateTime.Now.Year ? "selected" : null)">@i</option>
                }
            </select>
            <button class="btn btn-primary" onclick="loadDepartmentPayrolls()">Tải dữ liệu</button>
        </div>
    </div>

    <div id="departmentPayrollsContainer"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            loadDepartmentPayrolls();
        });

        function loadDepartmentPayrolls() {
            const year = $('#yearSelect').val();
            const month = $('#monthSelect').val();

            $.get(`/api/PayrollApprovalApi/GetDepartmentPayrollsForManager?year=${year}&month=${month}`, function (data) {
                let html = '<table class="table table-striped bg-white shadow-sm rounded">';
                html += '<thead class="bg-light"><tr><th>Mã NV</th><th>Họ tên</th><th>Thực nhận</th><th>Trạng thái</th><th>Hành động</th></tr></thead><tbody>';
                if (data && data.length > 0) {
                    data.forEach(payroll => {
                        html += `<tr>
                                            <td>${payroll.maNv}</td>
                                            <td>${payroll.hoTen}</td>
                                            <td>${payroll.thucNhan ? payroll.thucNhan.toLocaleString('vi-VN') : ''} VND</td>
                                            <td><span class="${getStatusClass(payroll.trangThai)}">${payroll.trangThai}</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-info" onclick="viewPayrollDetail(${payroll.maLuong})">Chi tiết</button>
                                                ${payroll.trangThai === 'BL1A' ? `<button class="btn btn-sm btn-success ms-2" onclick="sendToAccountant([${payroll.maLuong}])">Gửi kế toán</button>` : ''}
                                            </td>
                                        </tr>`;
                    });
                } else {
                    html += '<tr><td colspan="5" class="text-center">Không có dữ liệu bảng lương.</td></tr>';
                }
                html += '</tbody></table>';
                $('#departmentPayrollsContainer').html(html);
            }).fail(function (xhr) {
                $('#departmentPayrollsContainer').html(`<div class="alert alert-danger">Lỗi khi tải bảng lương phòng ban: ${xhr.responseText}</div>`);
                console.error("Lỗi tải bảng lương phòng ban:", xhr);
            });
        }

        function viewPayrollDetail(maNv) {
            window.location.href = `/Payroll/MyPayrol/${maNv}`;
        }

        function sendToAccountant(maLuongList) {
            Swal.fire({
                title: 'Gửi kế toán?',
                text: 'Bạn có chắc chắn muốn gửi các bảng lương này cho kế toán?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Gửi',
                cancelButtonText: 'Hủy',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/api/PayrollApprovalApi/SendToAccountant`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(maLuongList),
                        success: function (response) {
                            Swal.fire('Thành công!', response, 'success').then(() => {
                                loadDepartmentPayrolls();
                            });
                        },
                        error: function (xhr) {
                            Swal.fire('Lỗi!', xhr.responseText, 'error');
                        }
                    });
                }
            });
        }

        function getStatusClass(status) {
            switch (status) {
                case 'BL1': return 'badge bg-secondary';
                case 'BL1A': return 'badge bg-info';
                case 'BL1R': return 'badge bg-warning text-dark';
                case 'BL2': return 'badge bg-primary';
                case 'BL2R': return 'badge bg-warning text-dark';
                case 'BL3': return 'badge bg-success';
                case 'BL3R': return 'badge bg-warning text-dark';
                case 'BL4': return 'badge bg-success text-white bg-gradient';
                case 'BL5': return 'badge bg-light text-dark border';
                default: return 'badge bg-light text-dark border';
            }
        }
    </script>
}